import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:firebase_core/firebase_core.dart';
import 'package:flutter/material.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  await Firebase.initializeApp();
  runApp(const MyApp());
}

void showSnack(BuildContext context, String message) {
  ScaffoldMessenger.of(context).showSnackBar(
    SnackBar(content: Text(message)),
  );
}

class MyApp extends StatefulWidget {
  const MyApp({super.key});

  @override
  State<MyApp> createState() => _MyAppState();
}

class _MyAppState extends State<MyApp> {
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      home: AuthChecker(),
      routes: {
        "/login": (context) => const LoginPage(),
        "/register": (context) => const RegisterPage(),
        "/menu": (context) => const MenuPage(),
      },
      debugShowCheckedModeBanner: false,
    );
  }
}

class AuthChecker extends StatefulWidget {
  const AuthChecker({super.key});

  @override
  State<AuthChecker> createState() => _AuthCheckerState();
}

// STUDY THIS
class _AuthCheckerState extends State<AuthChecker> {
  @override
  Widget build(BuildContext context) {
    return StreamBuilder<User?>(
      stream: FirebaseAuth.instance.authStateChanges(),
      builder: (context, snapshot) {
        if (snapshot.connectionState == ConnectionState.waiting) {
          return const Center(child: CircularProgressIndicator());
        }

        if (snapshot.hasData) {
          return const MenuPage();
        } else {
          return const LoginPage();
        }
      },
    );
  }
}


class LoginPage extends StatefulWidget {
  const LoginPage({super.key});

  @override
  State<LoginPage> createState() => _LoginPageState();
}

class _LoginPageState extends State<LoginPage> {

  final emailController = TextEditingController();
  final passwordController = TextEditingController();

  @override
  void dispose() {
    emailController.dispose();
    passwordController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Center(
        child: Padding(
          padding: const EdgeInsets.all(40.0),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              Text("Login Form"),
              SizedBox(height: 20,),
              TextField(
                controller: emailController,
                decoration: InputDecoration(
                  border: OutlineInputBorder(),
                  labelText: "Email",
                ),
                autocorrect: false,
                keyboardType: TextInputType.emailAddress,
                textCapitalization: TextCapitalization.none,
              ),
              SizedBox(height: 20,),
              TextField(
                controller: passwordController,
                decoration: InputDecoration(
                  border: OutlineInputBorder(),
                  labelText: "Password",
                ),
                autocorrect: false,
                obscureText: true,
                keyboardType: TextInputType.visiblePassword,
                textCapitalization: TextCapitalization.none,
              ),
              SizedBox(height: 20,),
              ElevatedButton(
                onPressed: () async {
                  try {
                    final emailText = emailController.text.trim();
                    final passwordText = passwordController.text.trim();

                    if (emailText.isEmpty || passwordText.isEmpty) {
                      showSnack(context, "Please fill out all fields.");
                    } else {
                      await FirebaseAuth.instance.signInWithEmailAndPassword(
                        email: emailText,
                        password: passwordText,
                      ).then((value) {
                        showSnack(context, "Registered successfully!");
                        Navigator.pushReplacementNamed(context, '/menu');
                      });
                    }
                  } catch (e) {
                    showSnack(context, "Error: $e");
                  }
                },
                child: Text(
                  "Login"
                ),
              ),
              SizedBox(height: 20,),
              GestureDetector(
                onTap: () {
                  Navigator.pushReplacementNamed(context, '/register');
                },
                child: Text(
                  "Don't have an account yet? Register here.",
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

class RegisterPage extends StatefulWidget {
  const RegisterPage({super.key});

  @override
  State<RegisterPage> createState() => _RegisterPageState();
}

class _RegisterPageState extends State<RegisterPage> {

  final emailController = TextEditingController();
  final passwordController = TextEditingController();

  @override
  void dispose() {
    emailController.dispose();
    passwordController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Center(
        child: Padding(
          padding: const EdgeInsets.all(40.0),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              Text("Register Form"),
              SizedBox(height: 20,),
              TextField(
                controller: emailController,
                decoration: InputDecoration(
                  border: OutlineInputBorder(),
                  labelText: "Email",
                ),
                autocorrect: false,
                keyboardType: TextInputType.emailAddress,
                textCapitalization: TextCapitalization.none,
              ),
              SizedBox(height: 20,),
              TextField(
                controller: passwordController,
                decoration: InputDecoration(
                  border: OutlineInputBorder(),
                  labelText: "Password",
                ),
                autocorrect: false,
                obscureText: true,
                keyboardType: TextInputType.visiblePassword,
                textCapitalization: TextCapitalization.none,
              ),
              SizedBox(height: 20,),
              ElevatedButton(
                onPressed: () async {
                  try {
                    final emailText = emailController.text.trim();
                    final passwordText = passwordController.text.trim();

                    if (emailText.isEmpty || passwordText.isEmpty) {
                      showSnack(context, "Please fill out all fields.");
                    } else {
                      await FirebaseAuth.instance.createUserWithEmailAndPassword(
                        email: emailText,
                        password: passwordText,
                      ).then((value) {
                        showSnack(context, "Logged in successfully!");
                        Navigator.pushReplacementNamed(context, '/login');
                      });
                    }
                  } catch (e) {
                    showSnack(context, "Error: $e");
                  }
                },
                child: Text(
                    "Register"
                ),
              ),
              SizedBox(height: 20,),
              GestureDetector(
                onTap: () {
                  Navigator.pushReplacementNamed(context, '/login');
                },
                child: Text(
                  "Have an account already? Log in here.",
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

class MenuPage extends StatefulWidget {
  const MenuPage({super.key});

  @override
  State<MenuPage> createState() => _MenuPageState();
}

class _MenuPageState extends State<MenuPage> {

  List<ItemModel> items = [];

  final itemNameController = TextEditingController();
  final itemDescriptionController = TextEditingController();
  final itemPriceController = TextEditingController();
  final itemStockController = TextEditingController();

  final user = FirebaseAuth.instance.currentUser!;
  late final userEmail = user.email;

  // STUDY THIS
  final productsRef = FirebaseFirestore.instance.collection("Products")
  .withConverter<ItemModel>(fromFirestore: ItemModel.fromFirestore, toFirestore: (item, _) => item.toFirestore());

  @override
  void dispose() {
    itemNameController.dispose();
    itemDescriptionController.dispose();
    itemPriceController.dispose();
    itemStockController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text(
          "Main Menu"
        ),
        leading: GestureDetector(
          onTap: () async {
            try {
              await FirebaseAuth.instance.signOut();
              Navigator.pushReplacementNamed(context, '/login');
            } catch (e) {
              showSnack(context, "Error: $e");
            }
          },
          child: Icon(Icons.logout),
        ),
      ),
      // STUDY THIS
      body: StreamBuilder<QuerySnapshot<ItemModel>>(
        stream: productsRef.snapshots(),
        builder: (context, snapshot) {
          if (snapshot.connectionState == ConnectionState.waiting) {
            return Center(child: CircularProgressIndicator(),);
          }

          if (!snapshot.hasData) {
            return Center(child: Text("Current User: $userEmail\n\nNo available products."),);
          }

          final items = snapshot.data!.docs.map((doc) => doc.data()).toList();

          return ListView.builder(
            itemCount: items.length,
            itemBuilder: (context, index) {
              final item = items[index];
              return ListTile(
                title: Text(item.name),
                subtitle: Text(item.description),
                trailing: Row(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    Text("â‚±${item.price}\nStock: ${item.stock}"),
                    // DELETE ITEM
                    IconButton(
                      icon: Icon(Icons.delete, color: Colors.red),
                      onPressed: () async {
                        try {
                          await FirebaseFirestore.instance.collection("Products").doc(item.id).delete();
                          showSnack(context, "Product removed.");
                        } catch (e) {
                          showSnack(context, "Error: $e");
                        }
                      },
                    ),
                  ],
                ),
              );
            },
          );
        },
      ),
      floatingActionButton: FloatingActionButton(
        onPressed: () {
          showDialog(context: context, builder: (context) {
            return AlertDialog(
              content: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  Text("Create Product"),
                  SizedBox(height: 20,),
                  TextField(
                    controller: itemNameController,
                    decoration: InputDecoration(
                      border: OutlineInputBorder(),
                      labelText: "Name",
                    ),
                  ),
                  SizedBox(height: 20,),
                  TextField(
                    controller: itemDescriptionController,
                    decoration: InputDecoration(
                      border: OutlineInputBorder(),
                      labelText: "Description",
                    ),
                  ),
                  SizedBox(height: 20,),
                  TextField(
                    controller: itemPriceController,
                    decoration: InputDecoration(
                      border: OutlineInputBorder(),
                      labelText: "Price",
                    ),
                  ),
                  SizedBox(height: 20,),
                  TextField(
                    controller: itemStockController,
                    decoration: InputDecoration(
                      border: OutlineInputBorder(),
                      labelText: "Stock",
                    ),
                  ),
                  SizedBox(height: 20,),
                ],
              ),
              actions: [
                ElevatedButton(
                  onPressed: () {
                    Navigator.pop(context);
                  },
                  child: Text("Cancel"),
                ),
                ElevatedButton(
                  onPressed: () async {
                    try {
                      final String itemName = itemNameController.text.trim();
                      final String itemDescription = itemDescriptionController.text.trim();
                      final String priceText = itemPriceController.text.trim();
                      final String stockText = itemStockController.text.trim();

                      if (itemName.isEmpty || itemDescription.isEmpty || priceText.isEmpty || stockText.isEmpty) {
                        showSnack(context, "Please fill out all fields.");
                        return;
                      }

                      final double? itemPrice = double.tryParse(priceText);
                      final int? itemStock = int.tryParse(stockText);

                      if (itemPrice == null || itemStock == null) {
                        showSnack(context, "Invalid price or stock values.");
                        return;
                      }

                      // STUDY THIS
                      final item = ItemModel(
                        name: itemName,
                        description: itemDescription,
                        price: itemPrice,
                        stock: itemStock,
                      );

                      await FirebaseFirestore.instance.collection("Products").add(item.toFirestore());
                      showSnack(context, "Product added successfully!");

                      itemNameController.clear();
                      itemDescriptionController.clear();
                      itemPriceController.clear();
                      itemStockController.clear();
                    } catch (e) {
                      showSnack(context, "Error: $e");
                    }
                  },
                  child: Text("Confirm"),
                ),
              ],
            );
          });
        },
        child: Icon(
          Icons.add,
        ),
      ),
    );
  }
}

// STUDY THIS
class ItemModel {
  String? id;   // ID ADDED FOR ITEM DELETION
  String name;
  String description;
  double price;
  int stock;

  ItemModel({this.id, required this.name, required this.description, required this.price, required this.stock});

  factory ItemModel.fromFirestore(DocumentSnapshot<Map<String, dynamic>> snapshot, SnapshotOptions? options) {
    final data = snapshot.data();
    return ItemModel(
      id: snapshot.id,    // ID ADDED FOR ITEM DELETION
      name: data?["name"],
      description: data?["description"],
      price: data?["price"],
      stock: data?["stock"],
    );
  }

  Map<String, dynamic> toFirestore() {
    return {
      "name": name,
      "description": description,
      "price": price,
      "stock": stock,
    };
  }
}
